name: Test Docker Image

on:
  pull_request:
    branches:
      - main

jobs:
  build-and-publish:
    uses: ./.github/workflows/docker-build.yml
    with:
      image_name: ghcr.io/${{ github.repository }}
      tags: |
        type=raw,value=pr-${{ github.event.number }}
      push: true
    secrets: inherit

  test-health:
    needs: build-and-publish
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: docker pull ghcr.io/${{ github.repository }}:pr-${{ github.event.number }}

      - name: Run Docker container
        run: |
          docker run -d --rm --name test-container -p 8000:8000 ghcr.io/${{ github.repository }}:pr-${{ github.event.number }}

      - name: Wait for health check
        run: |
          echo "Waiting for container to become healthy..."
          for i in {1..30}; do
            HEALTH=$(docker inspect --format='{{json .State.Health.Status}}' test-container)
            echo "Health status: $HEALTH"
            if [ "$HEALTH" == "\"healthy\"" ]; then
              echo "Container is healthy!"
              exit 0
            fi
            if [ "$HEALTH" == "\"unhealthy\"" ]; then
              echo "Container is unhealthy!"
              docker logs test-container
              exit 1
            fi
            sleep 2
          done
          echo "Timed out waiting for container health check."
          docker logs test-container
          exit 1

      - name: Cleanup Container
        if: always()
        run: docker stop test-container || true

      - name: Delete ephemeral package version
        if: always()
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_NAME="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          TAG="pr-${{ github.event.number }}"

          echo "Identifying package version for tag: $TAG"

          # Fetch all versions and filter for the specific tag
          # Note: Using /users/ endpoint. If this fails for orgs, /orgs/ might be needed.
          # We'll try to determine the type or just try /users/ first.

          ALL_VERSIONS=$(gh api "/users/$OWNER/packages/container/$PACKAGE_NAME/versions" --jq '.[] | select(.metadata.container.tags[] | select(. == "$TAG")) | .id')

          # Count how many versions have this tag
          VERSION_COUNT=$(echo "$ALL_VERSIONS" | grep -c .)

          if [ "$VERSION_COUNT" -eq 0 ]; then
            echo "No package version found with tag $TAG. It might have been already deleted or never created."
          elif [ "$VERSION_COUNT" -eq 1 ]; then
            # This is the last tagged version, delete the entire package
            echo "Found 1 version with tag $TAG. This is the last tagged version. Deleting the entire package..."
            gh api -X DELETE "/users/$OWNER/packages/container/$PACKAGE_NAME"
            echo "Package deleted."
          else
            # There are other versions with this tag, delete just this version
            VERSION_ID=$(echo "$ALL_VERSIONS" | head -1)
            echo "Found $VERSION_COUNT versions with tag $TAG. Deleting version $VERSION_ID..."
            gh api -X DELETE "/users/$OWNER/packages/container/$PACKAGE_NAME/versions/$VERSION_ID"
            echo "Package version deleted."
          fi
